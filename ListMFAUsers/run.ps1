using namespace System.Net

# Input bindings are passed in via param block.
param($Request, $TriggerMetadata)

# Write to the Azure Functions log stream.
Write-Host "PowerShell HTTP trigger function processed a request."
#Let's hack the provisioning API to get per user MFA
$AADGraphtoken = (Get-GraphToken -scope "https://graph.windows.net/.default")
$tenantid = ((Get-Content "tenants.cache.json" | ConvertFrom-Json) | Where-Object -Property DefaultDomainName -EQ $Request.Query.TenantFilter).CustomerID
$MSOLXML = @"
<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://www.w3.org/2005/08/addressing"><s:Header><a:Action s:mustUnderstand="1">http://provisioning.microsoftonline.com/IProvisioningWebService/ListUsers</a:Action><a:MessageID>urn:uuid:$(New-Guid)</a:MessageID><a:ReplyTo><a:Address>http://www.w3.org/2005/08/addressing/anonymous</a:Address></a:ReplyTo><UserIdentityHeader xmlns="http://provisioning.microsoftonline.com/" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><BearerToken xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService">$($AADGraphtoken['Authorization'])</BearerToken><LiveToken i:nil="true" xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService"/></UserIdentityHeader><BecContext xmlns="http://becwebservice.microsoftonline.com/" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><DataBlob xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService">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</DataBlob><PartitionId xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService">2</PartitionId></BecContext><ClientVersionHeader xmlns="http://provisioning.microsoftonline.com/" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><ClientId xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService">50afce61-c917-435b-8c6d-60aa5a8b8aa7</ClientId><Version xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService">1.2.183.57</Version></ClientVersionHeader><ContractVersionHeader xmlns="http://becwebservice.microsoftonline.com/" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><BecVersion xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService">Version47</BecVersion></ContractVersionHeader><TrackingHeader xmlns="http://becwebservice.microsoftonline.com/">4e6cb653-c968-4a3a-8a11-2c8919218aeb</TrackingHeader><a:To s:mustUnderstand="1">https://provisioningapi.microsoftonline.com/provisioningwebservice.svc</a:To></s:Header><s:Body><ListUsers xmlns="http://provisioning.microsoftonline.com/"><request xmlns:b="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration.WebService" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><b:BecVersion>Version16</b:BecVersion><b:TenantId>$($tenantid)</b:TenantId><b:VerifiedDomain i:nil="true"/><b:UserSearchDefinition xmlns:c="http://schemas.datacontract.org/2004/07/Microsoft.Online.Administration"><c:PageSize>500</c:PageSize><c:SearchString i:nil="true"/><c:SortDirection>Ascending</c:SortDirection><c:SortField>None</c:SortField><c:AccountSku i:nil="true"/><c:BlackberryUsersOnly i:nil="true"/><c:City i:nil="true"/><c:Country i:nil="true"/><c:Department i:nil="true"/><c:DomainName i:nil="true"/><c:EnabledFilter i:nil="true"/><c:HasErrorsOnly i:nil="true"/><c:IncludedProperties i:nil="true" xmlns:d="http://schemas.microsoft.com/2003/10/Serialization/Arrays"/><c:IndirectLicenseFilter i:nil="true"/><c:LicenseReconciliationNeededOnly i:nil="true"/><c:ReturnDeletedUsers i:nil="true"/><c:State i:nil="true"/><c:Synchronized i:nil="true"/><c:Title i:nil="true"/><c:UnlicensedUsersOnly i:nil="true"/><c:UsageLocation i:nil="true"/></b:UserSearchDefinition></request></ListUsers></s:Body></s:Envelope>
"@
$Users = (Invoke-RestMethod -Uri "https://provisioningapi.microsoftonline.com/provisioningwebservice.svc" -Method post -Body $MSOLXML -ContentType 'application/soap+xml; charset=utf-8').envelope.body.ListUsersResponse.listusersresult.returnvalue.results.user
$SecureDefaultsState = (New-GraphGetRequest -Uri "https://graph.microsoft.com/beta/policies/identitySecurityDefaultsEnforcementPolicy" -tenantid $Request.query.TenantFilter ).IsEnabled
$CAPolicies = (New-GraphGetRequest -Uri "https://graph.microsoft.com/beta/identity/conditionalAccess/policies" -tenantid $Request.query.TenantFilter )
$CAState = foreach ($Policy in $CAPolicies) {
    if ($policy.grantControls.builtincontrols -ne 'mfa') { continue }
    if ($Policy.conditions.applications.includeApplications -ne "All") {
        Write-Host $Policy.conditions.applications.includeApplications
        "Specific Applications"
        continue
    }
    if ($Policy.conditions.users.includeUsers -eq "All") {
        'All Users'
        continue
    }        
}
if (!$CAState) { $CAState = "None" }
$MFARegistration = (New-GraphGetRequest -uri "https://graph.microsoft.com/beta/reports/credentialUserRegistrationDetails" -tenantid $Request.query.TenantFilter)

# Interact with query parameters or the body of the request.
$GraphRequest = $Users | ForEach-Object {
    
    $PerUser = if ($_.StrongAuthenticationRequirements.StrongAuthenticationRequirement.state -ne $null) { $_.StrongAuthenticationRequirements.StrongAuthenticationRequirement.state } else { "Disabled" }
    $MFARegUser = if (($MFARegistration | Where-Object -Property UserPrincipalName -EQ $_.UserPrincipalName).IsMFARegistered -eq $null) { $false } else { ($MFARegistration | Where-Object -Property UserPrincipalName -EQ $_.UserPrincipalName).IsMFARegistered }
    [PSCustomObject]@{
        UPN             = $_.UserPrincipalName
        PerUser         = $PerUser
        MFARegistration = $MFARegUser
        CoveredByCA     = ($CAState -join ", ")
        CoveredBySD     = $SecureDefaultsState
    }
}
# Associate values to output bindings by calling 'Push-OutputBinding'.
Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{
        StatusCode = [HttpStatusCode]::OK
        Body       = @($GraphRequest)
    })