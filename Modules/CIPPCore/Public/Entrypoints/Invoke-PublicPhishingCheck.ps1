using namespace System.Net

Function Invoke-PublicPhishingCheck {
    <#
    .FUNCTIONALITY
    Entrypoint
    #>
    [CmdletBinding()]
    param($Request, $TriggerMetadata)
    Write-Host ($request | ConvertTo-Json)
    if ($request.headers.Referer -notlike '*login.microsoftonline.com*') {
        $bytes = [Convert]::FromBase64String('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAbEAAAFUCAMAAACdh/KyAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAALxUExURf9rAv+4hv+0f/+vd/+udf+lZv+TR/+iYf+SRf+qbv+5h/+zfv+qb/+yfP+PQP+pbP+cV//9/P/////Vt/9sA/+1gP/gyv/gy/93Fv/MqP/Zv//Nqv/YvP+mZ//Kpf/bwf/s3//Clv/Hn/+AJv/Gnf/hzP/Prf/Em//Qr//cxP95Gv/q3P/fyP+ELf+xev+HMv+XTf/Wuv90Ev+JNv9/JP+GMP+aUv+QQf9wC/+xe/+YUP9xDf+fXP+RRP+DLP+pbf+bVf9+Iv+udv+ZUf9sBP+NPf+scv+QQv+eWv+XTv+RQ/+tc/+dWP+VSv+FLv9+I/+gXf+naf+IM/+fW/+rcP+weP+iYP+USP+JNf+maP+jY//Wuf/izv+5iP/t4P/Utf/m1P/OrP/x6P+/kv/KpP/cw//bwv/Nqf/Xu/+USf/07f/Oq//o2P9wCv/hzf/59f+NPP/Jo//Ss/+VS//x5//48//z6/+8jP/m1f/28f+3hP+INP/AlP+6if+TRv+oa//Ak//8+/+KN//w5v/Utv9zD/90Ef/v5f/VuP+/kf/28P/q2/91E/+hX/9uB//Rsf+OPv+CKf96G/+kZP9vCP+aU//y6f/Cl/+BKP+wef+tdP+CKv+1gf+yff+8jf+FL/97Hf/r3v+WTP9yDv/n1v/17v+MOv9vCf+9jv/+/v96HP97Hv9tBf/Ssv/49P/v5P/u4//t4f94Gf/Dmf+gXv/dxf94GP/17/+eWf+bVP92Ff/7+f/k0v/dxv/o2f/awP+0gP+KOP/y6v/ex//Zvv+LOf9zEP93F/+YT//FnP+7i//8+v+cVv/6+P/u4v/r3f/p2v/RsP+jYv/k0f/z7P/j0P/n1/+nav/69/++kP+2gv+7iv/fyf98IP9tBv9/Jf+DK//Lp//TtP+4hf+OP/98H/+lZf9xDP+3g//jz/+MO/+GMf/59v+BJ/+scf92FP/Jov/38v/Prv/Gnv/9/f/l0//Blf/Emv/Iof99If/HoLeG1L8AAAAJcEhZcwAADsMAAA7DAcdvqGQAAA44SURBVHja7dp5vM31vsfxN7Yjy/zKFO1M7QyhbdjLlDlzKKfIUBo2MhRpU+ccQ2UbSoQcUyokU0JRtqFQtuEgUUkpVFcI3ZM6p+756/7xW2vttbfhVkfd+7jezz/24/f9/b6/729479+w1vpIZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZ2ieXKnSchISHvH85ZkO8iK10hKX8oVCB+XsFQqNA5HQuHQqHIZJFQKHfckqJZS+wXKUbgyuLZZpeg5IXzKkVp6SooEz+3LFx9TtdEIDJ5DZSLWxKC8j77/05iVIifWzH76c2mElBaujYp6bpfkljlpKQq8dd2UlJVn/1fmVhJVbseqkuqUbRm0RskJZeDWsm1JdXJlydvXUkp4XC9+skNGkqNEoEbk9U4OTlZUpPEPE2bNc+eWDgcVuEWLW+KJNaqdUtJbYL+ddoWSmwnqUZycrKKh8Nhte/QVpJ0c4OOCofDkTEah8OdOt9yaxdJuumPt93etZsk6Y7ut9aJ9mqVmNCj9GWamHpCL+lOAO6U7gKghzr1BqCgFIKedwP36EYA7o3cFe8LLtDUbIkBFYA+pZUIVAH6Ru6KN/UD4P7IXbE/DBgIDJIeKAc8OBiGBGM8BEOLAXmlh9MAGHSDdAtAPxgmPVwSgJaXY2LDH3kUuEolgD8Bd8YS6wsl/3w33KZQ9Ob5l2yJNQRG5ALq5UiMNGCkEqOrNQwS6wH3j7oaKsYSC4zWY8DjAE/EEgNgWH2NgYG3l4d0jb03MneAxo2HCU8+BQ0v1+fYxKfrAw00CZise+AZqSMgJcKVCgFT2gDdNBV4OvLmMW3ILc9O/+sMGJ0jsZmaCfcqEWg6C+gRJDYbyswJP6esa4y51dLgeQ2CkF7IntiL8wbDJNVol7f+1IowX62ABS/1gTR1gIVSBXjhMkzs5fkPXlNIWgQs1jygiVIhVcoTvQRmKARJ0r0QzpaYui2pvjS4cWZPLKzmwLJEuFdKgvxBYk2Cq7f3K1mJLderkEsr4GHVzpZYX6ksLNHi26qMB1iptrBKmgOvqWJ038pcns8xSZoKvK4aQGmthorSGljRq1T1N/qWeTMEVaW1kKFZcYmtAx6adN25ieXVEGB9IpSXekFC5O3+pdYDywPPxBLbIL0KS7QRWqh9tsQWSm9BSG/DphKbYaW2AGOVChOVC97pVfLdquW2KjMzM/OyTExpcNW2CfCaFIJaszQNWK96+XssUAh6SRsgQ9uBHe2CxFKhhGq/dm5iack7IU2J8I40CGYHid1ac8RobYG7sq4xqSdU0N9g14i07HfFmonAmr/AMKkKrJTSYGMq8Kjaw2tSRsFJ3ZQOT12eie2OPPx3SD0A2moELL1yD3RXCAZJQIY0AHgvSGwmDHpwL5An55sHQAslwgppVSyxVFhRMQlGxCfWB2ZqWing5XPfPN5XXWDfBGC4tB9gEHwgPQMflgOuuIwT06SPoFjfxpLUF2ghhYYBB56NfkURJPbxQdgVJFatDwy+phD0yZHYPY/Dk9FP0ANiiemTYcCwkOIT6wUzpUb5ry0yNlti45Pg/UwpBNy1bjB0kvp/eiijKXwgKXUp8FlHXW6JZVd/Vmxq6lhJ0rRK6yVJ27Zti/yRVHdabI3XP5c0duzY+FGAVqq7+LxbOFxt1vasVnTURhqz9YVmag8siyW2UbWrBb2OPBBs4+iqLzZP1kPwpSQtfqXz05K0fPny5f4q5N8CtPql61SAXb13QV/FEqt+bq9dsLcqkMcn+X89sQcmALCvdFZifc7ttXs+wJ++8jm+tI4ePfor1qr0HxmNYzdlTb3AICn9m2Uu9ik2MzMzM7P/B3IVSEhIaN3/2C9aaU10IhQK7b9Yx69Coa8vuPBwuEDqnRddvfiCiyzcfSkOPxQKvXi+mbdcrC1NmX6B8X6HIoYZke/IU4//7FVO8EZ08iTMvFjXUrDzQsv2rwx+La1zoQ43fcJDFxy52UQuxeGft1JkIXxysfaUN6h73tEaLuT3S+zn/5abCvf/3MTSk5JGXGBR4eiG37vQ/+smWH2hgUdlldVd+sS2JiU9cpH263D+xL65RDv1Pya291jjWgRFTOM6ztmf9ZXggnD4yLR1sztKkjrdXHP3KUnJVSE9eWz2xK4omLeeJOmV/bdNiathS05O/kZdwuEpjdo1yFFCczXQYtuO0zBC0rJ2t69ZJAWVc5ndv54nJX8G6cmSmn+dULBoDUlS7cJNP14gqVIBIDlZkrS+aLNmkormy3dGSml7+7oUSdUyMjKkjIyMFC0Ih48Urhkp0dK8Z+d8m9El2Lk564LEwuGwUvYnpkjtZu8I9rqLhoTDdcY1bNAu2paGdJ3do79UfA2QN1k7wuHm9WYvkurmbVGw6FHplRbRnercssGNT0SOZnHX7v95yROTmgO5pDUzAK6MPtSqwN9fBpZIOgRBn+BeNik+sXaDAD47JbVKA67L+lcrBTv1CPQ+AFwVv93jQAFJuTq8KGn0aYB+43QYKAHsSYn8LlpYc4OJ3pK+3QWwsqFyA0RuztWANroJOKVPANgsdQWkMVBCVWAgfBZs9nai5XfaB6wFWuo7eBKg+0fA3yN3wZlwtjxQMdI+silS59cOgNMaCv3gDZ0IhhyqDgB8JCUA8P1hjQPKwqjfIDGlwUAVBsYApbISC9TWiUhl3J/Pk9iZXTDsBxg/XW8BKzg3sUBK3Ha3AIWjjXXARCBdhwGKAanRxOoAqzcfhFu0Bph/N3AsPjG9C9/rr5CmF4DPgAbqChuk6yOJES2SOwNcW2gMNFVrYDjRxOJsjyUWqBS0D0HFhqvg27jEgAWLgNUlikFGNLEewD+ALzQOCM7vpU9sEPRVLaisY0CzWGLjX7wVqDQWSFAPoLiegXuyPcd2Qk9N/g46rAdmq/J5EhvyB6Bx3HZ3AIuijQ/ghFoBrQ4DQ5efhXTpQVgiHd6SMVr9J0IunYVUad8Xj03RgrhHRjd4XGUhfzXgVhWE0+oKa6UPoondHP0Rp07Rj9V+I/xT5WC1ZkYT+3L7j0DXtsCiWGJ7toSz2j9BlYJF50maBhyThgK7t+uBzLaj1XE+fKrCwU6tgtZaBxwdB1RZtuw3SexteFUzoJmUBLNjiZVVaSBlCrBc/wXM0lXwr2yJlYIOUhWocAOwTcnnJlZd+hDaxW23C3CjpM0ju2g5MEVaCfkOA1M0GzZJ5eBTSZmhvgcBDukuiH4YiE9MKyEFeKkjrJA6AcvWwHjp3UhiA2JdU06UWQHwo+bDfjWKJpagrnC9tBY6xhLbKp2GxkE7vAeAncvjEhsuSd/c2WdP8MQIEtsONJEGQ8NxQPJv8eYh9QdOaCEkStfDs1nPMdUHTtUA1usUUFs7oXK2xHrCCWkrzN0GbFGBcxPbJK2AdXGFasu/g4GS3oFNehl2SCtgwWHgDs2G6lI6zJUygbKJ38MhvQ8fS2e2rJdGwZ7YMbSAdOinTGC6WgGTi8LLWYnFnqBTgbOj34If9QG0Vt1oYqMjie2BlrHE0iWgW+Tt/kyhL1cCI+MSS5XUCuiX9yfIpSGAdBhopQeAReOAG6RLW503AwavfvU07DmiyrD3uT9mVcdUgXuCxDQcrtl2P+yV/gbpU+MTyw0ln0gGmqkvvPfYeZ5jJaWlsE7DoVZk0WNAlRPzgUV6FU5+nhc4dhjYotlwUroGrk3RSKgsvQWHtA++7PLcozBXdwBbMuPe0aGjdBBuG1cV/qE2wMh/Eknsp2jHBjBQSocfdRZWdr0vmtgcdYXxkbf9aGKb4hMrknt1e90IE1QfWNNRQ+FaSS/ATKkk5NJR4InCqgp93iwISxuNA46qcHALueSfx7pLpSNl7Uuy3jzSI4llRHo9HNRHsTv+XfFksOwLadQK4AAszZHY3RI5ElP1yJA7peciteQNFCSWGw5ImwG2PA/FZj4K3KdTPwTdVkq1AbZGh3oSGKNI0R5QT9WCov1IYvuiHZvCwcrBG2H76IFH7or7YUCOxErGJ/YWHKzwPhSRXgOe0tDgeV4CHq+wEFii6QAllRkZuKnGAU1+i8SKfZf0xQ2S9M1ZoPxoZSU2IZKYum6EYpvaSNIbQOv4xDr96wdYWVOS6jR4smtj2JAjsYnnSWxx5bXAqhOSNGoCMHGSIomNhInS+reBdcV7w67e+eF9qXE6cHBCNUklisGB6FCdgw8eUt4DsKvWEEkJsGHuvkhiE2KHexaKlekOaVKPtRSbuzeWWBE4nSOxk/GJHf8J4MMikvINBjQUhkqafCVsGFoQDkizH4dVUrtNwN279dskltPnjbKmt2UreTseK8I4PnVsztXm1ZYkfbjvqzN6HibGL1ueNUyOQrXPU2IDLe+8OLrN6BrStkrHJW2vq6wCu2mxwrupb8bG6Qh0CiYbnYnMe/obafr06dGjiCpdKWuw57KOUznq+6RGOdrSS8vOPB2ZbL4sbtztnbOGPPO6JGnykcNxI/9frs7bCGnpwD9/z43yKNDTX+r/KluCR9rM33Wjg4CTlXzyf6UmV2S0qvb7bvKKZs3a+MSbmZmZmZmZXW7+G1XPYNgFVHxvAAAAAElFTkSuQmCC')
        Write-AlertMessage -message "Potential Phishing page detected at $($request.headers.Referer)" -sev 'Alert' -tenant $Request.query.TenantId
    } else {
        Write-Host 'Not being phished'
    }
    # Associate values to output bindings by calling 'Push-OutputBinding'.
    Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{
            StatusCode  = [HttpStatusCode]::OK
            ContentType = 'image/png'
            Body        = $bytes    
        })

}